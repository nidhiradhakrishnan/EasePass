<!DOCTYPE html>
<html>
<head>
    <title>QR Code Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js" integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link rel="stylesheet" href="easepass.css">

<style>
    main {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #reader {
        width: 600px;
    }
    #result {
        text-align: center;
        font-size: 1.5rem;
    }
</style>
</head>
<body>
<main>
    <div id="reader"></div>
    <div id="result"></div>
</main>

<div class="app" id="component" style="display: none;">

    <div class="bg"></div>

    <form>
        <header>
            <img src="idcard.png">
        </header>
<label>Student name:</label>
        <label id="username" ></label><br>
<label>date of birth:</label>
        <label id="dateofbirth" ></label><br>
<label>educational institution:</label>
        <label id="educationalinstitution"></label><br>
<label>course of study:</label>
        <label id="courseofstudy" ></label><br>
<label>Departure:</label>
        <label id="startingpoint" ></label><br>
<label>Destination:</label>
        <label id="endingpoint" ></label><br>
<label>Start date:</label>
        <label id="startDate" ></label><br>
<label>End Date:</label>
        <label id="endDate" ></label><br>
<label><input type="checkbox" name="travel" id="onwardtravel" value="onward"> Onward travel</label>
<label><input type="checkbox" name="travel" id="returntravel" value="return"> Return travel</label>

  <button type="button" id="back2" onclick="redirect()">Mark </button>
</form>
 </div>

    <script>
        const scanner = new Html5QrcodeScanner('reader', {
        // Scanner will be initialized in DOM inside element with id of 'reader'
        qrbox: {
            width: 250,
            height: 250,
        },  // Sets dimensions of scanning box (set relative to reader element width)
        fps: 20, // Frames per second to attempt a scan
    });


    scanner.render(success, error);
    // Starts scanner

    function success(result) {
    
        
        scanner.clear();
        // Clears scanning instance

        document.getElementById('reader').remove();
        // Removes reader element from DOM since no longer needed
   

        var data = 
        {   
            "username":result
             };

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:8080/studentlistdetails", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        
        xhr.onreadystatechange = () => {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.status ==="invalid applicant") {
                         alert("Invalid applicant");
                    } else 
                    {
           document.getElementById("component").style.display="block";

           document.getElementById("username").innerHTML=response.username;
           document.getElementById("dateofbirth").innerHTML=response.dateofbirth;
           document.getElementById("educationalinstitution").innerHTML=response.educationalinstitution;
           document.getElementById("courseofstudy").innerHTML=response.courseofstudy;
           document.getElementById("startingpoint").innerHTML=response.startingpoint;
           document.getElementById("endingpoint").innerHTML=response.endingpoint;
           document.getElementById("startDate").innerHTML=response.startDate;
           document.getElementById("endDate").innerHTML=response.endDate;
           document.getElementById("onwardtravel").checked=response.onward=="yes";
           document.getElementById("returntravel").checked=response.return=="yes";
           document.getElementById("onwardtravel").disabled=response.onward=="yes";
           document.getElementById("returntravel").disabled=response.return=="yes";

                    }
                } else {
                    alert("Request failed with status: " + xhr.status);
                }
            }
        };
        
        xhr.send(JSON.stringify(data));
    }

    function error(err) {
        console.error(err);
        // Prints any errors to the console
    }
 
    function redirect() {
      var data = {
            "student": document.getElementById("username").innerHTML,
            "conductor": localStorage.getItem("username")                          
                   
             };

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:8080/conductormark", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        
        xhr.onreadystatechange = () => {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.status === "apply success") {
                         alert("marked successfully");
                        window.location.href = 'conductorhome.html';

                    } else {
                        alert("already marked ");
                    }
                } else {
                    alert("Request failed with status: " + xhr.status);
                }
            }
        };
        
        xhr.send(JSON.stringify(data));




    }
</script>
    </script>
</body>
</html>